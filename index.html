<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Usipa Koperasi</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;background:#f5f5f5}.header{background:#007bff;color:#fff;padding:16px;text-align:center}.tab-bar{display:flex;background:#eee}.tab-btn{flex:1;padding:12px;background:none;border:none;cursor:pointer}.tab-btn:hover{background:#ddd}.tab-btn.active{background:#fff;font-weight:bold;border-bottom:3px solid #007bff}.container{max-width:1200px;margin:0 auto;padding:20px}.page{display:none}.page.active{display:block}.card{background:#fff;padding:20px;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.1)}.section-title{font-size:18px;font-weight:bold;margin:20px 0 12px;display:flex;justify-content:space-between;align-items:center}.form-group{margin-bottom:12px}.form-group label{display:block;margin-bottom:4px;font-weight:500}.form-group input,.form-group select{width:100%;padding:10px;border:1px solid #ccc;border-radius:4px}.btn{padding:10px 20px;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-right:8px}.btn:hover{background:#0056b3}.btn-success{background:#28a745}.btn-success:hover{background:#218838}.btn-danger{background:#dc3545}.btn-danger:hover{background:#c82333}.btn-info{background:#17a2b8}.btn-info:hover{background:#138496}.btn-warning{background:#ffc107;color:#212529}.btn-warning:hover{background:#e0a800}.btn-sm{padding:6px 12px;font-size:12px}.btn-refresh{background:#17a2b8;padding:8px 16px;font-size:14px}.btn-refresh:hover{background:#138496}.loan-item{padding:10px;border:1px solid #ddd;border-radius:4px;margin:8px 0;cursor:pointer}.loan-item:hover{background:#f0f0f0}.loan-item.selected{background:#e3f2fd;border-color:#007bff;border-width:2px}.status-badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:bold}.status-lunas{background:#d4edda;color:#155724}.status-belum{background:#fff3cd;color:#856404}.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:20px 0}.stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:8px;text-align:center}.stat-card.green{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%)}.stat-card.blue{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)}.stat-card.orange{background:linear-gradient(135deg,#fa709a 0%,#fee140 100%)}.stat-card.profit{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}.stat-card.cash{background:linear-gradient(135deg,#56ab2f 0%,#a8e6cf 100%)}.stat-value{font-size:28px;font-weight:bold;margin:8px 0}.stat-label{font-size:14px;opacity:.9}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}.modal.active{display:flex}.modal-content{background:#fff;padding:24px;border-radius:8px;max-width:400px;width:90%}.modal-header{font-size:18px;font-weight:bold;margin-bottom:12px}.modal-body{margin-bottom:20px;white-space:pre-line}.info-box{background:#e3f2fd;border-left:4px solid #2196f3;padding:12px;margin:12px 0;border-radius:4px}.warning-box{background:#fff3cd;border-left:4px solid #ffc107;padding:12px;margin:12px 0;border-radius:4px}.error-box{background:#f8d7da;border-left:4px solid #dc3545;padding:12px;margin:12px 0;border-radius:4px}table{width:100%;border-collapse:collapse;margin:16px 0}th,td{padding:12px;text-align:left;border-bottom:1px solid #ddd}th{background:#f8f9fa;font-weight:bold}tr:hover{background:#f9f9f9}.id-cell{font-family:monospace;color:#666;font-size:11px}.selected-member{background:#d4edda;padding:8px;border-radius:4px;margin:8px 0;border-left:4px solid #28a745}.small-text{font-size:12px;color:#777}details{margin-bottom:10px}summary{cursor:pointer;font-weight:bold}.edit-input{background:#fffbe6;border:1px solid #ffc107;padding:4px;border-radius:4px}.save-all-btn{margin-top:10px}.import-btn{background:#28a745}.import-btn:hover{background:#218838}
  </style>
</head>
<body>
  <div class="header"><h1>Usipa Koperasi</h1></div>
  <div class="tab-bar">
    <button class="tab-btn active" onclick="switchPage(this, 'anggota')">Anggota</button>
    <button class="tab-btn" onclick="switchPage(this, 'pinjaman')">Pinjaman</button>
    <button class="tab-btn" onclick="switchPage(this, 'pembayaran')">Pembayaran</button>
    <button class="tab-btn" onclick="switchPage(this, 'laporan')">Laporan</button>
  </div>
  <div class="container">

    <!-- ANGGOTA -->
    <div id="page-anggota" class="page active">
      <details open>
        <summary>Tambah Anggota</summary>
        <div class="card">
          <div class="form-group"><label>ID Anggota *</label><input type="text" id="idAnggota" placeholder="Contoh: 0001, KMP-001, atau kosongkan untuk auto"></div>
          <div class="form-group"><label>Nama *</label><input type="text" id="nama"></div>
          <div class="form-group"><label>Tanggal Daftar</label><input type="date" id="tglDaftar"></div>
          <button class="btn" onclick="addMember()">Tambah</button>
        </div>
      </details>
      <details open>
        <summary>Daftar Anggota</summary>
        <div class="card">
          <div class="section-title">
            <span></span>
            <div>
              <button class="btn btn-success save-all-btn" onclick="saveAllMembers()" style="display:none" id="saveAllBtn">Save All</button>
              <button class="btn btn-refresh" onclick="refreshMember()">Refresh</button>
            </div>
          </div>
          <table><thead><tr><th>ID</th><th>Nama</th><th>Tgl Daftar</th><th>Pinjaman</th><th>Sisa Hutang</th><th>Aksi</th></tr></thead><tbody id="memberList"></tbody></table>
        </div>
      </details>
    </div>

    <!-- LAPORAN -->
    <div id="page-laporan" class="page">
      <details open>
        <summary>Import Data dari Excel</summary>
        <div class="card">
          <input type="file" id="importFile" accept=".xlsx" style="margin-bottom:10px">
          <button class="btn import-btn" onclick="importExcel()">Import Excel</button>
          <div class="info-box">File harus punya sheet: Anggota, Pinjaman, Pembayaran, Ringkasan</div>
        </div>
      </details>
      <!-- ... (modal, dll tetap sama) -->
    </div>
  </div>

  <!-- MODAL -->
  <div id="modal" class="modal" onclick="if(event.target===this)closeMod()">
    <div class="modal-content">
      <div class="modal-header" id="modTit"></div>
      <div class="modal-body" id="modBod"></div>
      <div style="text-align:right"><button class="btn" onclick="closeMod()">OK</button></div>
    </div>
  </div>

  <script>
    let members=[],loans=[],payments=[],selLoan=null,currentPayMemberId=null;
    let nextMemberId = 1;
    let profitHistory = [];
    let modalAwal = 0;
    let modalTambah = 0;
    let editedMembers = new Set(); // untuk save all

    const uid=()=>Date.now()+''+Math.random().toString(36).substr(2,9),
    round=n=>Math.round((n+Number.EPSILON)*100)/100,
    fmtRp=n=>'Rp '+n.toLocaleString('id-ID'),
    fmtDt=d=>d?new Date(d).toLocaleDateString('id-ID'):new Date().toLocaleDateString('id-ID'),
    nameOf=id=>members.find(x=>x.id===id)?.nama||'-',
    loansOf=mid=>loans.filter(l=>l.memberId===mid),
    actLoans=mid=>loansOf(mid).filter(l=>l.status!=='Lunas');

    function showMod(t,m){document.getElementById('modTit').textContent=t;document.getElementById('modBod').innerHTML=m;document.getElementById('modal').classList.add('active')}
    function closeMod(){document.getElementById('modal').classList.remove('active')}

    // === EDIT ANGGOTA ===
    function editMember(id, field, input) {
      const value = input.value.trim();
      const member = members.find(m => m.id === id);
      if (!member) return;

      if (field === 'tglDaftar') member[field] = fmtDt(value);
      else member[field] = value;

      editedMembers.add(id);
      document.getElementById('saveAllBtn').style.display = 'inline-block';
      saveData();
    }

    function saveAllMembers() {
      saveData();
      editedMembers.clear();
      document.getElementById('saveAllBtn').style.display = 'none';
      showMod('Sukses', 'Semua perubahan disimpan!');
    }

    function rendMem(){
      const d=document.getElementById('memberList');
      if(!members.length){d.innerHTML='<tr><td colspan="6" style="text-align:center">Belum ada anggota</td></tr>';return}
      d.innerHTML=members.map(m=>{
        const ml=loansOf(m.id),sh=ml.reduce((s,l)=>s+Math.max(0,l.total-l.paidAmount),0);
        return`<tr>
          <td class="id-cell"><strong>${m.id}</strong></td>
          <td><input type="text" class="edit-input" value="${m.nama}" onchange="editMember('${m.id}', 'nama', this)"></td>
          <td><input type="date" class="edit-input" value="${m.tglDaftar.split('/').reverse().join('-')}" onchange="editMember('${m.id}', 'tglDaftar', this)"></td>
          <td style="text-align:center">${ml.length}</td>
          <td><strong>${fmtRp(sh)}</strong></td>
          <td><button class="btn btn-danger btn-sm" onclick="delMember('${m.id}')">Hapus</button></td>
        </tr>`}).join('');
    }

    // === IMPORT EXCEL ===
    function importExcel() {
      const file = document.getElementById('importFile').files[0];
      if (!file) return showMod('Error', 'Pilih file Excel dulu!');

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        let imported = 0;

        // Anggota
        if (workbook.SheetNames.includes('Anggota')) {
          const sheet = XLSX.utils.sheet_to_json(workbook.Sheets['Anggota']);
          members = sheet.map(row => ({
            id: String(row.ID || row.id),
            nama: row.Nama || row.nama,
            tglDaftar: row['Tgl Daftar'] || row.tglDaftar
          }));
          const ids = members.map(x => parseInt(x.id.replace(/\D/g, '')) || 0);
          nextMemberId = ids.length > 0 ? Math.max(...ids) + 1 : 1;
          imported++;
        }

        // Pinjaman
        if (workbook.SheetNames.includes('Pinjaman')) {
          const sheet = XLSX.utils.sheet_to_json(workbook.Sheets['Pinjaman']);
          loans = sheet.map(row => {
            const memberId = members.find(m => m.nama === row.Anggota)?.id;
            if (!memberId) return null;
            return {
              id: uid(),
              memberId,
              pokok: Number(row.Pokok),
              tenor: Number(row.Tenor.replace(' bln', '')),
              total: Number(row.Total),
              angsuran: Number(row.Cicilan),
              paidAmount: Number(row.Terbayar),
              status: row.Status === 'Lunas' ? 'Lunas' : 'Belum lunas',
              createdAt: row.Tanggal,
              wajibCicilan: row.Cicilan ? true : false
            };
          }).filter(Boolean);
          imported++;
        }

        // Pembayaran
        if (workbook.SheetNames.includes('Pembayaran')) {
          const sheet = XLSX.utils.sheet_to_json(workbook.Sheets['Pembayaran']);
          payments = sheet.map(row => {
            const memberId = members.find(m => m.nama === row.Anggota)?.id;
            const loan = loans.find(l => l.memberId === memberId && Math.abs(l.total - l.paidAmount - row.Nominal) < 1);
            return {
              id: uid(),
              loanId: loan?.id || '',
              memberId: memberId || '',
              amount: Number(row.Nominal),
              date: row.Tanggal
            };
          }).filter(p => p.memberId);
          imported++;
        }

        // Ringkasan
        if (workbook.SheetNames.includes('Ringkasan')) {
          const sheet = XLSX.utils.sheet_to_json(workbook.Sheets['Ringkasan']);
          const modalAwalRow = sheet.find(r => r.Keterangan === 'Modal Awal');
          const modalTambahRow = sheet.find(r => r.Keterangan === 'Modal Tambahan');
          if (modalAwalRow) modalAwal = Number(modalAwalRow.Nilai) || 0;
          if (modalTambahRow) modalTambah = Number(modalTambahRow.Nilai) || 0;
          profitHistory = sheet.filter(r => r.Keterangan.startsWith('RESET:')).map(r => ({
            date: r.Keterangan.split(' - ')[0].replace('RESET: ', ''),
            kategori: r.Keterangan.split(' - ')[1]?.split(' ')[0] || '',
            keterangan: r.Keterangan.split(' - ').slice(1).join(' - '),
            jumlah: Math.abs(Number(r.Nilai))
          }));
          imported++;
        }

        saveData();
        refreshMember(); rendLoan(); rendPay(); updRep();
        showMod('Import Sukses', `${imported} sheet berhasil diimport!`);
      };
      reader.readAsArrayBuffer(file);
    }

    // === FUNGSI LAIN TETAP SAMA ===
    function saveData(){ /* ... (sama seperti sebelumnya) */ }
    function loadData(){ /* ... */ }
    function addMember(){ /* ... */ }
    function delMember(id){ /* ... */ }
    function refreshMember(){rendMem()}
    // ... (semua fungsi lain tetap sama)

    loadData();
    rendMem(); rendLoan(); rendPay(); updRep();
    document.getElementById('modalAwal').value = modalAwal;
  </script>
</body>
</html>

